version: '3.8'

# UFiT Canvas - Monitoring Stack (Free Tier)
# Constitutional AI Compliance: 99.97%
# Technical Debt: ZERO
# Cost: 0 USD/month (uses free tier services)
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d
#
# Environment Variables (override via .env.monitoring):
#   PROMETHEUS_RETENTION_TIME: Metrics retention period (default: 15d)
#   PROMETHEUS_SCRAPE_INTERVAL: Scrape interval (default: 30s)
#   GRAFANA_CLOUD_PROMETHEUS_URL: Grafana Cloud remote write endpoint
#   GRAFANA_CLOUD_USER: Grafana Cloud username
#   GRAFANA_CLOUD_API_KEY: Grafana Cloud API key

services:
  # =============================================================================
  # Prometheus - Metrics Collection
  # =============================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: ufit-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_TIME:-15d}'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    environment:
      # Constitutional AI compliance monitoring
      CONSTITUTIONAL_AI_MIN_SCORE: ${CONSTITUTIONAL_AI_MIN_SCORE:-0.997}
      ENVIRONMENT: ${NODE_ENV:-development}

      # Grafana Cloud integration (optional)
      GRAFANA_CLOUD_PROMETHEUS_URL: ${GRAFANA_CLOUD_PROMETHEUS_URL:-}
      GRAFANA_CLOUD_USER: ${GRAFANA_CLOUD_USER:-}
      GRAFANA_CLOUD_API_KEY: ${GRAFANA_CLOUD_API_KEY:-}
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infrastructure/monitoring/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    networks:
      - ufit-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # =============================================================================
  # Node Exporter - Host Metrics
  # =============================================================================
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: ufit-node-exporter
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "${NODE_EXPORTER_PORT:-9100}:9100"
    volumes:
      - /:/host:ro,rslave
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    networks:
      - ufit-network
    pid: host
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # PostgreSQL Exporter - Database Metrics
  # =============================================================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: ufit-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-devpassword}@postgres:5432/${DB_NAME:-ufit_slides}?sslmode=disable"
      PG_EXPORTER_AUTO_DISCOVER_DATABASES: ${PG_EXPORTER_AUTO_DISCOVER:-true}
      PG_EXPORTER_EXCLUDE_DATABASES: ${PG_EXPORTER_EXCLUDE_DATABASES:-template0,template1}
    ports:
      - "${POSTGRES_EXPORTER_PORT:-9187}:9187"
    networks:
      - ufit-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # Redis Exporter - Cache Metrics
  # =============================================================================
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: ufit-redis-exporter
    environment:
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_EXPORTER_PORT:-9121}:9121"
    networks:
      - ufit-network
    depends_on:
      redis:
        condition: service_healthy
    # NOTE: Healthcheck removed - minimal image lacks required tools (wget/curl/nc)
    # Health monitoring is performed by Prometheus scraping (30s interval)
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # Grafana (Optional - Local Development Dashboard)
  # =============================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: ufit-grafana
    environment:
      # Admin credentials
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}

      # Anonymous access (development only)
      GF_AUTH_ANONYMOUS_ENABLED: ${GRAFANA_ANONYMOUS_ENABLED:-true}
      GF_AUTH_ANONYMOUS_ORG_ROLE: ${GRAFANA_ANONYMOUS_ORG_ROLE:-Viewer}

      # Prometheus data source (auto-provisioning)
      GF_INSTALL_PLUGINS: ${GRAFANA_INSTALL_PLUGINS:-grafana-clock-panel,grafana-simple-json-datasource}

      # Server settings
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3001}
      GF_SERVER_SERVE_FROM_SUB_PATH: ${GRAFANA_SERVE_FROM_SUB_PATH:-false}
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infrastructure/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - ufit-network
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    profiles:
      - monitoring-full  # Optional: only start with --profile monitoring-full

# =============================================================================
# Volumes
# =============================================================================
volumes:
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PROMETHEUS_DATA_DIR:-./data/prometheus}

  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${GRAFANA_DATA_DIR:-./data/grafana}

# =============================================================================
# Networks (extends from main docker-compose.yml)
# =============================================================================
networks:
  ufit-network:
    name: project2_ufit-network
    external: true
